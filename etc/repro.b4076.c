
#define _GNU_SOURCE
#include <endian.h>
#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <unistd.h>

static uintptr_t syz_open_dev(uintptr_t a0, uintptr_t a1, uintptr_t a2)
{
  if (a0 == 0xc || a0 == 0xb) {
    char buf[128];
    sprintf(buf, "/dev/%s/%d:%d", a0 == 0xc ? "char" : "block", (uint8_t)a1,
        (uint8_t)a2);
    return open(buf, O_RDWR, 0);
  } else {
    char buf[1024];
    char* hash;
    strncpy(buf, (char*)a0, sizeof(buf));
    buf[sizeof(buf) - 1] = 0;
    while ((hash = strchr(buf, '#'))) {
      *hash = '0' + (char)(a1 % 10);
      a1 /= 10;
    }
    return open(buf, a2, 0);
  }
}

uint64_t r[1] = {0xffffffffffffffff};
void loop()
{
  long res;
  memcpy((void*)0x20000140, "/dev/fd#", 9);
  res = syz_open_dev(0x20000140, 0, 0x801);
  if (res != -1)
    r[0] = res;
  memcpy(
      (void*)0x20000180,
      "\x48\x56\xbc\x0a\xdc\x80\x59\xbf\xc9\xa6\xa5\x3b\x84\x00\x41\x1d\x35\xf3"
      "\x09\x93\x1b\x07\x00\x00\x00\x00\x00\x00\x00\xf3\x00\x68\x3e\x7b\xef\x52"
      "\xd7\x52\x99\xad\x14\x76\xcd\x15\xb9\x11\x6f\xf0\x30\x54\x48\xa4\x6c\x17"
      "\xb2\xdd\x3e\x78\xec\xa4\xaa\x01\x4c\x43\x04\x5e\x28\xd1\x31\x65\x4e\x26"
      "\x6b\xf6\xf6\x60\xb5\xc3\x7f\x44\x2f\x3c\xba\xac\xf9\x75\x31\x2a\x27\x07"
      "\x2b\x26\x6c\x3e\xd5\x88\xb7\x8e\x3f\x00\x88\x5e\x75\x59\x42\xfa\x28\x1b"
      "\xea\x84\x78\xa4\x2c\x10\xb6\x3a\x2f\x56\xe0\x10\xb9\x96\x42\x9d\x7d\xad"
      "\xb8\x7d\x7d\x78\xe3\x32\x17\x96\xd5\xda\x4a\xa4\x94\x20\x01\xee\xa8\xe9"
      "\xc2\xab\xb2\x14\x74\x5d\xf3\xb7\x13\xca\x48\x91\xd5\xfc\x7d\xe5\x3e\xfa"
      "\x69\x56\x48\x3f\xd6\x27\xe8\x4c\x46\xdb\xd3\xb9\x98\xb4\x6f\x2b\xc4\x2c"
      "\x7b\x2f\x3b\xb1\xec\x0a\x91\xb6\x3d\xec\xc5\xa0\x25\x7a\x18\xa5\x24\x7a"
      "\xd5\x29\xa2\x01\xdc\xf8\xf7\x00\xff\x48\xe3\x48\xf1\x92\x60\x6d\x78\x9f"
      "\x8f\x82\xe4\xdd\xd7\x68\xec\xe4\xf0\xca\xd3\x9f\x99\xb0\x84\x79\xf4\x1d"
      "\x20\xf2\x0a\x9a\x3d\x15\x50\x84\x1e\x22\x6d\x31\x14\xc3\xd4\xaa\x3f\x3d"
      "\x53\x97\x8f\x36\x06\xae\x7c\x8e\x2b\x5a\x50\xdd\xcd\x9d\xf2\x40\x94\x6f"
      "\xea\x6b\xd4\xf0\xa3\x6f\x53\xe0\x16\x24\x90\xfc\x32\x66\xfb\x86\x3a\xec"
      "\xfb\xcf\x5e\x6a\xa5\x86\x04\xe3\x73\xd2\xfa\xec\x4b\x40\xa4\x98\xa3\x74"
      "\x22\x5e\x2e\x59\xa5\xb1\x1c\xdd\x1e\xff\x57\xb2\xeb\x3f\x53\x88\x33\xb7"
      "\x86\xf5\xbb\xad\x4e\xf5\x51\x87\x99\x69\x85\x91\xe9\x49\xd4\x22\x1d\x29"
      "\xec\x70\x3f\x8f\x79\xd8\x11\xcc\xf5\x63\xe4\x73\x5c\x22\x9b\x44\x9f\x16"
      "\x8e\x87\xe0\x5d\x0b\x21\x5a\x74\x25\xe1\xfa\x03\x11\xaf\xb6\x57\x64",
    377);
  syscall(__NR_ioctl, r[0], 0x258, 0x20000180);
}

int main()
{
  syscall(__NR_mmap, 0x20000000, 0x1000000, 3, 0x32, -1, 0);
  loop();
  return 0;
}
